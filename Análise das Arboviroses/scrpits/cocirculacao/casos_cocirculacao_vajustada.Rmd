---
title: "Casos cocirculação bahia 2016-2019"
output:
  word_document:
    toc: yes
  html_document:
    highlight: tango
    lib_dir: libs
    number_sections: yes
    theme: yeti
    toc: yes
    toc_float:
      collapse: yes
---

```{r setup,include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, comment = '', warning = FALSE)
```

```{r}
library(data.table)
library(tidyverse)
library(read.dbc)
library(foreign)
library(dplyr)
require("stringr")
require(summarytools)
library(rapportools)
source("http://pcwww.liv.ac.uk/~william/R/crosstab.r")
```

<!-- # Leitura da base -->

```{r}
library(tibble)
library(readxl)
```

```{r}
load("/cloud/project/binomial/bases finais/base_analise_ha_v2.RData")
load("/cloud/project/binomial/bases finais/bahia_pop_long.RData")

data_arbo_long_v0107<-base_analise_ha_v2
```

# cenário de casos

```{r}
library(expss)
base_analise_ha_v2%>%
dplyr::select(ano,dg_conf,chik_conf,zika_conf, populacao)%>%
group_by(ano)%>%  
mutate(incidencia_dg= round(((dg_conf/populacao)*100000),2))%>%
mutate(incidencia_chik= round(((chik_conf/populacao)*100000),2))%>%
mutate(incidencia_zk= round(((zika_conf/populacao)*100000),2))%>%
dplyr::summarise_at(c("incidencia_dg", "incidencia_chik","incidencia_zk"), sum, na.rm = TRUE)%>%
# mutate(populacao= round(((populacao/4)),3))%>%
sort_desc(ano)%>%
# dplyr::select(macrorregiao,regiao.de.saude,dg_conf,chik_conf,zika_conf,tx_dg,tx_chik,tx_zk,populacao)
knitr::kable(.,"simple")
 
```


## Casos confirmados (anual) por Município

```{r}
# seleciona municipios com pelo menos 1 caso de arbovirose
incid_arboviroses_ano<-data_arbo_long_v0107%>%dplyr::select(mun,ano,dg_conf,chik_conf,zika_conf,populacao,semiarido)%>%
  filter(dg_conf>0 &chik_conf>0 & zika_conf>0)
  
```



```{r}
incid_arboviroses_ano%>%
  dplyr::select(ano,dg_conf,chik_conf,zika_conf, populacao)%>%
  group_by(ano)%>%  
  mutate(tx_dg= round(((dg_conf/populacao)),3))%>%
  mutate(tx_chik= round(((chik_conf/populacao)),3))%>%
  mutate(tx_zk= round(((zika_conf/populacao)),3))%>%
  group_by(ano)%>%    
  dplyr::summarise_at(c("dg_conf", "chik_conf","zika_conf","tx_dg", "tx_chik","tx_zk"), sum, na.rm = TRUE)%>%
  knitr::kable(.,"simple")
 
  
```
Populacao afetada
```{r}
library(Rmisc)
summarySE(incid_arboviroses_ano, measurevar="populacao", groupvars=c("ano"))%>%knitr::kable(.,"simple")
```

```{r}
incid_arboviroses_ano%>%
  dplyr::select(ano,populacao)%>%
  group_by(ano)%>%  
  dplyr::summarise_at(c("populacao"), sum, na.rm = TRUE)%>%
  knitr::kable(.,"simple")
```
```{r}
incid_arboviroses_ano%>%
  dplyr::select(populacao)%>%
  dplyr::summarise_at(c("populacao"), sum, na.rm = TRUE)%>%
  mutate(populacao= round(((populacao/4)),3))%>%
  knitr::kable(.,"simple")

 
```

Municipios com pelo menos uma ocorrência de arboviroses nos 4 anos.
```{r}
# 136 municipios com pelo menos um caso 
x<-crosstab(incid_arboviroses_ano, row.vars = "mun", col.vars = "ano", type = "r")
x

```

```{r}

mun_coc<-incid_arboviroses_ano%>%dplyr::select(mun, semiarido)%>%
 group_by(mun)%>%  
 sort_asc(mun)%>%
 count() %>%
  dplyr::filter(freq==4)

mun_coc%>%
 knitr::kable(.,"simple")
  
```


```{r}
municipios_todosanos<-mun_coc$mun
municipios_todosanos
```

```{r}
bahia_cocirculacao<-incid_arboviroses_ano%>%left_join(bahia_pop_long %>%
  dplyr::select(mun,ano,area,popporte,regiao.de.saude,macrorregiao),by = c('mun' = 'mun','ano'='ano'))


```


```{r}
bahia_cocirculacao%>%
dplyr::select(macrorregiao,dg_conf,chik_conf,zika_conf)%>%
group_by(macrorregiao)%>%
dplyr::summarise_at(c("dg_conf", "chik_conf","zika_conf"), sum, na.rm = TRUE)%>%
mutate(arboviroses=dg_conf+chik_conf+zika_conf)  

```

```{r}
bahia_cocirculacao%>%dplyr::filter(mun%in%municipios_todosanos)%>%
  dplyr::select(macrorregiao,regiao.de.saude,mun, semiarido)%>%
  sort_asc(macrorregiao, regiao.de.saude, mun,semiarido)%>%
  unique()%>%
  knitr::kable(.,"simple")
```


```{r}
mcro_rs_cocirc_todosanos<-bahia_cocirculacao%>%dplyr::filter(mun%in%municipios_todosanos)%>%
dplyr::select(ano,macrorregiao,regiao.de.saude,dg_conf,chik_conf,zika_conf, populacao)%>%
 group_by(ano,macrorregiao,regiao.de.saude)%>%  
 mutate(tx_dg= round(((dg_conf/populacao)),3))%>%
 mutate(tx_chik= round(((chik_conf/populacao)),3))%>%
 mutate(tx_zk= round(((zika_conf/populacao)),3))%>%
 group_by(macrorregiao,regiao.de.saude)%>%    
 dplyr::summarise_at(c("dg_conf", "chik_conf","zika_conf","tx_dg", "tx_chik","tx_zk"), sum, na.rm = TRUE)

mcro_rs_cocirc_todosanos%>%
  knitr::kable(.,"simple")
```

```{r}
bahia_cocirculacao%>%dplyr::filter(mun%in%municipios_todosanos)%>%
dplyr::select(populacao)%>%
dplyr::summarise_at(c("populacao"), mean, na.rm = TRUE)
```


```{r}
bahia_cocirculacao%>%dplyr::filter(mun%in%municipios_todosanos)%>%
dplyr::select(populacao)%>%
dplyr::summarise_at(c("populacao"), sum, na.rm = TRUE)%>%
mutate(populacao= round(((populacao/4)),3))  
```


```{r}
#mcro_rs_cocirc_todosanos<-bahia_cocirculacao%>%dplyr::filter(mun%in%municipios_todosanos)%>%
#dplyr::select(macrorregiao,regiao.de.saude,dg_conf,chik_conf,zika_conf, populacao)%>%
# group_by(macrorregiao,regiao.de.saude)%>%  
# dplyr::summarise_at(c("dg_conf", "chik_conf","zika_conf","populacao"), sum, na.rm = TRUE)%>%
# mutate(populacao= round(((populacao/4)),3))%>%
# mutate(tx_dg= round(((dg_conf/populacao)),3))%>%
# mutate(tx_chik= round(((chik_conf/populacao)),3))%>%
# mutate(tx_zk= round(((zika_conf/populacao)),3))%>%
# sort_asc(macrorregiao, regiao.de.saude, dg_conf,chik_conf,zika_conf )%>%
# dplyr::select(macrorregiao,regiao.de.saude,dg_conf,chik_conf,zika_conf,tx_dg,tx_chik,tx_zk,populacao)

#mcro_rs_cocirc_todosanos%>%
#  knitr::kable(.,"simple")
```



```{r}
library("ggplot2")
library("scales")
library("viridis")
library("hrbrthemes")

bahia_cocirculacao%>%dplyr::filter(mun%in%municipios_todosanos)%>%
dplyr::select(ano,macrorregiao,regiao.de.saude,dg_conf,chik_conf,zika_conf)%>%
 group_by(ano,macrorregiao,regiao.de.saude)%>%  
 dplyr::summarise_at(c("dg_conf", "chik_conf","zika_conf"), sum, na.rm = TRUE)%>%
 sort_asc(macrorregiao, regiao.de.saude, dg_conf,chik_conf,zika_conf )%>%
 dplyr::select(ano,macrorregiao,regiao.de.saude,dg_conf,chik_conf,zika_conf)%>%
  gather('variavel','casos_conf',dg_conf,chik_conf,zika_conf) %>% 
  mutate(variavel = fct_reorder(variavel, casos_conf,.desc = TRUE)) %>%
  ggplot( aes(x=casos_conf, y=macrorregiao, fill=variavel)) +
    geom_bar(stat="identity", position="stack") +
    scale_fill_viridis(discrete=TRUE, name="") +
    theme_ipsum() +
    xlab(" Casos confirmados")+
    ylab("Macrorregiao")+
    theme(axis.text.y=element_text(size=5),axis.text.x = element_text(size=5)
        )+   facet_wrap(~ano)

  

  
  
 ggsave("/cloud/project/binomial/bases finais/cocirc_todososanos_m.png")  

```


```{r}
bahia_cocirculacao%>%dplyr::filter(mun%in%municipios_todosanos)%>%
dplyr::select(ano,macrorregiao,regiao.de.saude,dg_conf,chik_conf,zika_conf)%>%
 group_by(ano,macrorregiao,regiao.de.saude)%>%  
 dplyr::summarise_at(c("dg_conf", "chik_conf","zika_conf"), sum, na.rm = TRUE)%>%
 sort_asc(macrorregiao, regiao.de.saude, dg_conf,chik_conf,zika_conf )%>%
 dplyr::select(ano,macrorregiao,regiao.de.saude,dg_conf,chik_conf,zika_conf)%>%
  gather('variavel','casos_conf',dg_conf,chik_conf,zika_conf) %>% 
  mutate(variavel = fct_reorder(variavel, casos_conf,.desc = TRUE)) %>%
  ggplot( aes(x=casos_conf, y=regiao.de.saude, fill=variavel)) +
    geom_bar(stat="identity", position="stack") +
    scale_fill_viridis(discrete=TRUE, name="") +
    theme_ipsum() +
    xlab(" Casos confirmados")+
    ylab("Região de saúde")+
    theme(axis.text.y=element_text(size=5),axis.text.x = element_text(size=5)
        )+   facet_wrap(~ano)

  

  
  
 ggsave("/cloud/project/binomial/bases finais/cocirc_todososanos_rs.png")  

```


```{r}
contagem_co_mrs<-bahia_cocirculacao%>%dplyr::select(macrorregiao,regiao.de.saude)%>%
 group_by(macrorregiao,regiao.de.saude)%>%  
 sort_asc(macrorregiao, regiao.de.saude)%>%
 count()%>%
dplyr::rename(municipios=freq)  

contagem_co_mrs%>%  
 knitr::kable(.,"simple")

```

```{r}
p<-contagem_co_mrs%>%
ggplot(aes(x = macrorregiao,
             y = regiao.de.saude, 
             size=municipios)) +
  geom_point()

p + 
  theme_bw() + 
  theme(axis.ticks.length = unit(-0.25, "cm"), 
        axis.ticks.margin = unit(0.5, "cm"))+
  theme(axis.title = element_text(size = 10),
        axis.text = element_text(size = 4))

ggsave("/cloud/project/binomial/bases finais/cocirc_mers.jpg")

p
```

```{r}
mcro_rs_cocirc<-bahia_cocirculacao%>%dplyr::select(macrorregiao,regiao.de.saude,dg_conf,chik_conf,zika_conf)%>%
 group_by(macrorregiao,regiao.de.saude)%>%  
 dplyr::summarise_at(c("dg_conf", "chik_conf","zika_conf"), sum, na.rm = TRUE)%>%
 sort_asc(macrorregiao, regiao.de.saude, dg_conf,chik_conf,zika_conf )%>%
 dplyr::select(macrorregiao,regiao.de.saude,dg_conf,chik_conf,zika_conf)

mcro_rs_cocirc%>%  
 knitr::kable(.,"simple")

```

```{r}
long_mcro_rs_cocirc<-mcro_rs_cocirc%>% 
  gather('variavel','casos_conf',dg_conf,chik_conf,zika_conf)

long_mcro_rs_cocirc%>%
  knitr::kable(.,"simple")
```



```{r}
bahia_cocirculacao%>%dplyr::select(macrorregiao,dg_conf,chik_conf,zika_conf, populacao)%>%
 group_by(macrorregiao)%>%  
 dplyr::summarise_at(c("dg_conf", "chik_conf","zika_conf","populacao"), sum, na.rm = TRUE)%>%
 mutate(populacao= round(((populacao/4)),3))%>%  
 mutate(arbovirose=dg_conf+chik_conf+zika_conf)%>%
 mutate(percent=round((arbovirose*100)/populacao),3)%>%  
 sort_asc(macrorregiao,arbovirose,percent,populacao)%>%
 dplyr::select(macrorregiao,arbovirose,percent,populacao)%>%
 knitr::kable(.,"simple")

```

macrorregiao

```{r}
library("forcats")
library("patchwork")

q1<-long_mcro_rs_cocirc%>%
mutate(variavel = fct_reorder(variavel, casos_conf,.desc = TRUE)) %>%
ggplot(aes(x=casos_conf, y=macrorregiao, fill=variavel)) +
    geom_boxplot(alpha=0.2)+
    theme_ipsum() +
    xlab(" Casos confirmados")+
    ylab("Macrorregião")+
    theme(axis.text.y=element_text(size=5),axis.text.x = element_text(size=5)
        )+facet_wrap(~variavel)
 

q1 + 
  theme_bw() + 
  theme(axis.ticks.length = unit(-0.25, "cm"), 
        axis.ticks.margin = unit(0.5, "cm"))+
  theme(axis.title = element_text(size = 10),
        axis.text = element_text(size = 4))

q1+ theme_bw()+plot_layout(guides='collect') &
theme(legend.position='none')

ggsave("/cloud/project/binomial/bases finais/circulacao_macro.jpg")
```

Regiao de saude
```{r}
q2<-long_mcro_rs_cocirc%>%
mutate(variavel = fct_reorder(variavel, casos_conf,.desc = TRUE)) %>%
ggplot(aes(x=casos_conf, y=regiao.de.saude, fill=variavel)) +
    geom_boxplot(alpha=0.3)+
   theme_ipsum() +
    xlab(" Casos confirmados")+
    ylab("Região de Saúde")+
    theme(axis.text.y=element_text(size=5),axis.text.x = element_text(size=5)
        )+facet_wrap(~variavel)
 
q2 + 
  theme_bw() + 
  theme(axis.ticks.length = unit(-0.25, "cm"), 
        axis.ticks.margin = unit(0.5, "cm"))+
  theme(axis.title = element_text(size = 10),
        axis.text = element_text(size = 5))

q2+ theme_bw()+  plot_layout(guides='collect') &
theme(legend.position='none')

ggsave("/cloud/project/binomial/bases finais/circulacao_rs.jpg")
```


```{r}
#https://ggplot2-book.org/arranging-plots.html
library(patchwork) #https://blog.curso-r.com/posts/2021-05-19-patchwork/

#q3 &
#  theme(legend.position='none')| q1 +theme(axis.text.y=element_text(size=5),axis.text.x = element_text(size=2)
#        )  & theme_minimal() &
#    plot_layout(guides='collect') &
#  theme(legend.position='none')

#q4<-q3+ inset_element(p7, left = 0.5, bottom = 0.5, right = 2, top = 1)
#q4 & theme_bw()
  
#plot_layout(ncol = 1)# alterando a largura

#ggsave("/cloud/project/binomial/bases finais/circulacao.jpg")
```
# por ano
```{r}
ano_mcro_rs_cocirc<-bahia_cocirculacao%>%dplyr::select(macrorregiao,regiao.de.saude, ano,dg_conf,chik_conf,zika_conf)%>%
 group_by(ano,macrorregiao,regiao.de.saude)%>%  
 dplyr::summarise_at(c("dg_conf", "chik_conf","zika_conf"), sum, na.rm = TRUE)%>%
 sort_asc(macrorregiao, regiao.de.saude, dg_conf,chik_conf,zika_conf )

long_ano_mcro_rs_cocirc<-ano_mcro_rs_cocirc%>% 
  gather('variavel','casos_conf',dg_conf,chik_conf,zika_conf)

```

```{r}
long_ano_mcro_rs_cocirc%>%
  knitr::kable(.,"simple")
```

```{r}
q3<-long_ano_mcro_rs_cocirc%>%
mutate(variavel = fct_reorder(variavel, casos_conf,.desc = TRUE)) %>%
ggplot(aes(x=casos_conf, y=macrorregiao, fill=variavel)) +
    geom_boxplot(alpha=0.3)+
    theme_ipsum() +
    xlab(" Casos confirmados")+
    ylab("Macrorregiao")+
    theme(axis.text.y=element_text(size=5),axis.text.x = element_text(size=5)
        )+   facet_wrap(~ano)

q3 + 
  theme_bw() + 
  theme(axis.ticks.length = unit(-0.25, "cm"), 
        axis.ticks.margin = unit(0.5, "cm"))+
  theme(axis.title = element_text(size = 10),
        axis.text = element_text(size = 6))

q3+ theme_bw()+plot_layout(guides='collect') &
theme(legend.position='bottom')

  
#q1+  plot_layout(guides='collect') &
#theme(legend.position='none')
ggsave("/cloud/project/binomial/bases finais/circulacao_ano_macro.png")

```


```{r}
q4<-long_ano_mcro_rs_cocirc%>%
mutate(variavel = fct_reorder(variavel, casos_conf,.desc = TRUE)) %>%
ggplot(aes(x=casos_conf, y=regiao.de.saude, fill=variavel)) +
    geom_boxplot()+
   theme_ipsum() +
    xlab(" Casos confirmados")+
    ylab("Região de Saúde")+
    theme(axis.text.y=element_text(size=3),axis.text.x = element_text(size=5)
        )+facet_wrap(~ano)

q4 + 
#  theme_bw() + 
  theme(axis.ticks.length = unit(-0.2, "cm"), 
        axis.ticks.margin = unit(0.4, "cm"))+
  theme(axis.title = element_text(size = 10),
        axis.text = element_text(size = 3))

q4+theme_bw()
ggsave("/cloud/project/binomial/bases finais/circulacao_ano_rs.png")


```
```{r}
long_ano_mcro_rs_cocirc%>%
mutate(variavel = fct_reorder(variavel, casos_conf,.desc = TRUE)) %>%
  ggplot( aes(x=casos_conf, y=regiao.de.saude, fill=variavel)) +
    geom_bar(stat="identity", position="stack") +
    scale_fill_viridis(discrete=TRUE, name="") +
    theme_ipsum() +
    xlab(" Casos confirmados")+
    ylab("Região de Saúde")+
    theme(axis.text.y=element_text(size=5),axis.text.x = element_text(size=5)
        )+   facet_wrap(~ano)
```


```{r}
p7<-long_ano_mcro_rs_cocirc%>%
mutate(variavel = fct_reorder(variavel, casos_conf,.desc = TRUE)) %>%
  ggplot( aes(x=casos_conf, y=macrorregiao, fill=variavel)) +
    geom_bar(stat="identity", position="stack") +
    scale_fill_viridis(discrete=TRUE, name="") +
    theme_ipsum() +
    xlab(" Casos confirmados")+
    ylab("Macrorregiao")+
    theme(axis.text.y=element_text(size=5),axis.text.x = element_text(size=5)
        )+   facet_wrap(~ano)
p7
```


```{r}
p7<-long_mcro_rs_cocirc%>%
  #dplyr::rename("municipios"=freq)%>%
  ggplot( aes(x=casos_conf, y=macrorregiao, fill=variavel)) +
    geom_bar(stat="identity", position="stack") +
    scale_fill_viridis(discrete=TRUE, name="") +
    theme_ipsum() +
    xlab(" Macrorregiao")+
    ylab("Região de Saúde")+
    theme(axis.text.y=element_text(size=8)#,axis.text.y = element_text(size=12)
        )
p7 + 
  theme_bw() + 
  theme(axis.ticks.length = unit(-0.25, "cm"), 
        axis.ticks.margin = unit(0.5, "cm"))+
  theme(axis.title = element_text(size = 10),
        axis.text = element_text(size = 3))

#p7
```


```{r}
library(expss) #fc sort_desc
dados_ba<-bahia_cocirculacao%>%
  dplyr::select(regiao.de.saude,dg_conf,chik_conf,zika_conf)%>%
  group_by(regiao.de.saude)%>%
  dplyr::summarise_at(c("dg_conf", "chik_conf","zika_conf"), sum, na.rm = TRUE)%>%
  sort_desc(dg_conf,chik_conf,zika_conf)
  #knitr::kable(.,"simple",caption = " tabela cocirculação por Regiao de Saúde")

```

```{r}
library("ggplot2")
long<-dados_ba%>% 
  gather('variavel','casos_conf',dg_conf,chik_conf,zika_conf)#%>% 
 # dplyr::select(regiao.de.saude,ano,arbovirose,everything())%>%
#  dplyr::select(-variavel)



#boxplot(casos_conf ~ variavel, long,col = c("red", "green", "purple"))

library("forcats")

q<-long%>%
mutate(variavel = fct_reorder(variavel, casos_conf,.desc = TRUE)) %>%
ggplot(aes(x=as.factor(variavel), y=casos_conf)) + 
    geom_boxplot(fill="slateblue", alpha=0.2) + 
    xlab("Arbovirose")

```
```{r}
bahia_cocirculacao%>%dplyr::select(dg_conf,chik_conf,zika_conf, populacao)%>%
 dplyr::summarise_at(c("dg_conf", "chik_conf","zika_conf","populacao"), sum, na.rm = TRUE)%>%
 mutate(populacao= round(((populacao/4)),3))%>%
 mutate(tx_dg= round(((dg_conf/populacao)*100),3))%>%
 mutate(tx_chik= round(((chik_conf/populacao)*100),3))%>%
 mutate(tx_zk= round(((zika_conf/populacao)*100),3))%>%
knitr::kable(.,"simple")
```

```{r}
bahia_cocirculacao%>%dplyr::select(ano,dg_conf,chik_conf,zika_conf, populacao)%>%
  group_by(ano)%>%  
 dplyr::summarise_at(c("dg_conf", "chik_conf","zika_conf","populacao"), sum, na.rm = TRUE)%>%
 mutate(tx_dg= round(((dg_conf/populacao)*100),3))%>%
 mutate(tx_chik= round(((chik_conf/populacao)*100),3))%>%
 mutate(tx_zk= round(((zika_conf/populacao)*100),3))%>%
knitr::kable(.,"simple")
```


p<-x%>%
ggplot(aes(x = macrorregiao,
             y = regiao.de.saude, 
             size=tx_G12A)) +
  geom_point()+
  

p + 
  theme_bw() + 
  theme(axis.ticks.length = unit(-0.25, "cm"), 
        axis.ticks.margin = unit(0.5, "cm"))+
  theme(axis.title = element_text(size = 10),
        axis.text = element_text(size = 4))

ggsave("/cloud/project/binomial/bases finais/g12a_mers.jpg")
```{r}


```

```{r}
ggplot(long, aes(x =casos_conf , y = regiao.de.saude , fill = variavel)) +   
  geom_boxplot()
```
