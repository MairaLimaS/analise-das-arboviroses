---
word_document:
  html_document:
    code_folding: hide
    highlight: tango
    lib_dir: libs
    number_sections: yes
    theme: yeti
    toc: yes
    toc_float:
      collapse: yes
date: "`r Sys.Date()`"
title: "Analise dos municipios 2016-2019 por Porte, IDH e Tipo"
output:
  html_document:
    df_print: paged
  word_document: default
editor_options:
  markdown:
    wrap: 72
---

```{r setup,include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, comment = '', warning = FALSE)
```

```{r}
library(data.table)
library(tidyverse)
library(read.dbc)
library(foreign)
library(dplyr)
require("stringr")
require(summarytools)
library(rapportools)
source("http://pcwww.liv.ac.uk/~william/R/crosstab.r")
```

<!-- # Leitura da base -->

```{r}
library(tibble)
library(readxl)
```

```{r}
load("/cloud/project/binomial/bases finais/bahia_pop_long.RData")
```



# Porte dos municipios

Segundo o IBGE, o porte do município é aferido pelo tamanho da população. 
Municípios de pequenho porte I têm população abaixo de 20 mil habitantes, aqueles cuja a faixa populacional está entre 20 e 50 mil habitantes são classificados como de Pequeno Porte II. Municípios entre 50 e 100 mil habitantes são classificados como de Médio Porte. Os municípios de grande porte tem população entre 100 e 900 mil habitantes. A população nas metrópoles deve ultrapassar os 900 mil habitantes.


A maior parte dos municípios da Bahia são de Pequeno Porte (89,93%) donde 249 municípios são de Pequeno Porte I e 126 de Pequeno Porte II. 26 munícipios são de Médio Porte, ou seja tem população entre 50 e 100 mil habitantes, 15 de grande porte e 1 métropole, que é Salvador.


# Municipios por macrorregiao e regiao de saude
```{r}
count_regiao<-bahia_pop_long%>% dplyr::filter(ano==2019)%>%
   dplyr::select(macrorregiao,regiao.de.saude)%>%
   group_by(macrorregiao,regiao.de.saude)%>%
   count()%>%
   dplyr::rename(municipios=freq)%>%
   sort_desc(macrorregiao,regiao.de.saude,municipios)
#%>% mutate(densidade= round((populacao/area),3))

count_regiao%>%
knitr::kable(.,"simple")
```

```{r}
bahia_pop_long%>% dplyr::filter(ano==2019)%>%
   dplyr::select(macrorregiao)%>%
   group_by(macrorregiao)%>%
   count()%>%
   dplyr::rename(municipios=freq)%>%
   sort_desc(municipios,macrorregiao)
```

```{r}
resumo_area<-bahia_pop_long%>% dplyr::filter(ano==2019)%>%
      dplyr::select(macrorregiao,regiao.de.saude, area, populacao)%>%
      group_by(macrorregiao,regiao.de.saude)%>%
      mutate(densidade= round((populacao/area),3))%>%
      dplyr::summarise_at(c("area", "densidade"), sum, na.rm = TRUE)%>%
      mutate(area= area-1)%>%
      mutate(densidade= densidade-1)%>%
      sort_desc(macrorregiao)

```

```{r}
bahia_pop_long%>% dplyr::filter(ano==2019)%>%
      dplyr::select(macrorregiao,area, populacao)%>%
      group_by(macrorregiao)%>%
      mutate(densidade= round((populacao/area),3))%>%
      dplyr::summarise_at(c("area", "densidade"), sum, na.rm = TRUE)%>%
      mutate(area= area-1)%>%
      mutate(densidade= densidade-1)%>%
      sort_desc(area,densidade,macrorregiao)
```

```{r}
bahia_pop_long%>% dplyr::filter(ano==2019)%>%
      dplyr::select(macrorregiao,area, populacao)%>%
      group_by(macrorregiao)%>%
      mutate(densidade= round((populacao/area),3))%>%
      dplyr::summarise_at(c("area", "densidade"), sum, na.rm = TRUE)%>%
      mutate(area= area-1)%>%
      mutate(densidade= densidade-1)%>%
      sort_desc(densidade,area,macrorregiao)
```

```{r}
  
resumo_macro_rs<-count_territorio_anos%>% 
      dplyr::select(macrorregiao,regiao.de.saude,densidade)%>%
      group_by(macrorregiao,regiao.de.saude)%>%
     # mutate(densidade= round((populacao/area),3))%>%
      dplyr::summarise_at(c("densidade"), mean, na.rm = TRUE)%>%
      dplyr::rename(densidade_media=densidade)%>%
      sort_desc(macrorregiao)

resumo_macro_rs%>%
      knitr::kable(.,"simple")

```

```{r}

resumo_macro_rs<-resumo_macro_rs%>%
left_join(resumo_area %>% dplyr::select(macrorregiao,regiao.de.saude,area),by = c('macrorregiao' = 'macrorregiao', 'regiao.de.saude'='regiao.de.saude'))%>%  
left_join(count_regiao,by = c('macrorregiao' = 'macrorregiao', 'regiao.de.saude'='regiao.de.saude'))%>%
  dplyr::select(macrorregiao,regiao.de.saude,municipios,area, densidade_media)
 
resumo_macro_rs%>%
      knitr::kable(.,"simple")


```


```{r}
resumo_macro_rs%>% 
      dplyr::select(macrorregiao,area, densidade_media)%>%
      group_by(macrorregiao)%>%
      dplyr::summarise_at(c("area", "densidade_media"), sum, na.rm = TRUE)%>%
      mutate(area= area-1)%>%
      mutate(densidade_media= densidade_media-1)%>%
      sort_desc(densidade_media,area,macrorregiao)%>%
      knitr::kable(.,"simple")

```

```{r}
resumo_macro_rs%>% 
      dplyr::select(regiao.de.saude,area, densidade_media)%>%
      group_by(regiao.de.saude)%>%
      dplyr::summarise_at(c("area", "densidade_media"), sum, na.rm = TRUE)%>%
      mutate(area= area-1)%>%
      mutate(densidade_media= densidade_media-1)%>%
      sort_desc(densidade_media,area,regiao.de.saude)%>%
      knitr::kable(.,"simple")
```
```{r}
bahia_pop_long_v2<-bahia_pop_long%>% 
      dplyr::select(mun,area, populacao, newtipology)%>%
      group_by(mun)%>%
      mutate(densidade= round((populacao/area),3))
```


```{r}
resumo_mun<-bahia_pop_long_v2%>%
      dplyr::select(mun,area,densidade,newtipology)%>%
      group_by(mun,area,newtipology)%>%
      dplyr::summarise_at(c("densidade"), mean, na.rm = TRUE)%>%
      dplyr::rename(densidade_media=densidade)%>%
      sort_desc(area,densidade_media,mun)

resumo_mun%>%
      knitr::kable(.,"simple")
```


```{r}
resumo_macro_rs<-bahia_pop_long%>% 
      dplyr::select(macrorregiao,regiao.de.saude,area,)%>%
      group_by(macrorregiao,regiao.de.saude)%>%
     # mutate(densidade= round((populacao/area),3))%>%
      dplyr::summarise_at(c("densidade"), mean, na.rm = TRUE)%>%
      dplyr::rename(densidade_media=densidade)%>%
      sort_desc(macrorregiao)
```

```{r}
png("/cloud/project/binomial/bases finais/tipologia_area_dens.jpg") 
p<-resumo_mun%>%
  dplyr::mutate(tipologia = case_when(
  newtipology== 1 ~ 'Intermediario Adjacente',
  newtipology== 2 ~ 'Intermediario Remoto', 
  newtipology== 3 ~ 'Rural Adjacente',
  newtipology== 4 ~ 'Rural Remoto',
  newtipology== 5 ~ 'Urbano')) %>%
  group_by(tipologia)%>%
  dplyr::summarise_at(c("area", "densidade_media"), sum, na.rm = TRUE)%>%
  mutate(area= area-1)%>%
  mutate(densidade_media= densidade_media-1)%>%
  gather('variavel','territorio',area,densidade_media) %>% 
  mutate(variavel = fct_reorder(variavel, territorio,.desc = TRUE)) %>%
  ggplot( aes(x=territorio, y=tipologia, fill=variavel)) +
    geom_bar(stat="identity", position="stack") +
    scale_fill_viridis(discrete=TRUE, name="") +
    theme_ipsum() +
    xlab(" Território")+
    ylab("Tipo do Município")+
    theme(axis.text.y=element_text(size=9),axis.text.x = element_text(size=8)
        )#+   facet_wrap(~ano)

print(p)
dev.off()
```

